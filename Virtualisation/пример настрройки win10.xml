

Что здесь реализовано:
Функция	Реализуется чем	Примечание
Сеть (интернет)	<interface type='network' source='default' model='virtio'/>	VirtIO — быстрая сетевая карта
Видео и динамическое разрешение	<video model='virtio'/> + SPICE	Требуется spice-guest-tools в Windows
Буфер обмена и drag&drop	<graphics type='spice'> + <channel spicevmc>	Должен работать spice-vdagent.exe в госте
        Звук	<sound model='ich9'/> + <audio type='spice'/>	Работает без отдельного драйвера
        Общие папки	<filesystem type='mount' driver='virtiofs' .../>	Работает с virtiofs-драйвером на госте
        USB редирект	<redirdev type='spicevmc'/>	Можно подключать флешки напрямую
        Hyper-V оптимизация	<hyperv> блок	Ускоряет работу Windows-гостя

   https://chatgpt.com/share/69002662-c5a0-800a-a360-864959e7adc5
___________________________________
<domain type='kvm'>
    <name>windows10</name>
    <uuid>11111111-2222-3333-4444-555555555555</uuid>
    <memory unit='MiB'>8192</memory>
    <vcpu placement='static'>4</vcpu>

    <os>
        <type arch='x86_64' machine='pc-q35-9.0'>hvm</type>
        <boot dev='hd'/>
    </os>

    <features>
        <acpi/>
        <apic/>
        <hyperv>
            <relaxed state='on'/>
            <vapic state='on'/>
            <spinlocks state='on' retries='8191'/>
        </hyperv>
        <kvm>
            <hidden state='on'/>
        </kvm>
    </features>

    <cpu mode='host-passthrough' check='none'/>
    <clock offset='localtime'/>
    <on_poweroff>destroy</on_poweroff>
    <on_reboot>restart</on_reboot>
    <on_crash>restart</on_crash>

    <devices>
        <!-- Диск Windows -->
        <disk type='file' device='disk'>
            <driver name='qemu' type='qcow2' cache='writeback'/>
            <source file='/var/lib/libvirt/images/windows10.qcow2'/>
            <target dev='vda' bus='virtio'/>
            <address type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/>
        </disk>

        <!-- Диск с драйверами virtio -->
        <disk type='file' device='cdrom'>
            <driver name='qemu' type='raw'/>
            <source file='/usr/share/virtio-win/virtio-win.iso'/>
            <target dev='sdb' bus='sata'/>
            <readonly/>
        </disk>

        <!-- Видео: Virtio-GPU (новый Windows) -->
        <video>
            <model type='virtio' heads='1' primary='yes'/>
        </video>

        <!-- Отображение: SPICE -->
        <graphics type='spice' autoport='yes' listen='127.0.0.1'>
            <listen type='address' address='127.0.0.1'/>
            <clipboard copypaste='yes'/>
            <filetransfer enable='yes'/>
        </graphics>

        <!-- Канал SPICE -->
        <channel type='spicevmc'>
            <target type='virtio' name='com.redhat.spice.0'/>
        </channel>

        <!-- Звук -->
        <sound model='ich9'/>
        <audio id='1' type='spice'/>

        <!-- Устройства ввода -->
        <input type='tablet' bus='usb'/>
        <input type='keyboard' bus='usb'/>

        <!-- Сеть через NAT -->
        <interface type='network'>
            <source network='default'/>
            <model type='virtio'/>
        </interface>

        <!-- Общая папка virtiofs -->
        <filesystem type='mount' accessmode='passthrough'>
            <driver type='virtiofs'/>
            <source dir='/home/mikan/share'/>
            <target dir='shared'/>
        </filesystem>

        <!-- USB редирект -->
        <redirdev bus='usb' type='spicevmc'/>
        <redirfilter>
            <usbdev class='0x0000' vendor='0x0000' product='0x0000' allow='yes'/>
        </redirfilter>

        <!-- Шина PCI -->
        <controller type='usb' model='qemu-xhci'/>
        <controller type='pci' model='pcie-root'/>
    </devices>
</domain>
_____________________________________________________
Пример XML для Windows с GPU passthrough



<domain type='kvm'>
    <name>windows11-gpu</name>
    <uuid>aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee</uuid>
    <memory unit='MiB'>16384</memory>
    <vcpu placement='static'>8</vcpu>

    <os>
        <type arch='x86_64' machine='pc-q35-9.0'>hvm</type>
        <boot dev='hd'/>
    </os>

    <features>
        <acpi/>
        <apic/>
        <hyperv>
            <relaxed state='on'/>
            <vapic state='on'/>
            <spinlocks state='on' retries='8191'/>
        </hyperv>
        <kvm>
            <hidden state='on'/> <!-- скрывает гипервизор от NVIDIA -->
        </kvm>
    </features>

    <cpu mode='host-passthrough' check='none'>
        <topology sockets='1' cores='4' threads='2'/>
    </cpu>

    <clock offset='localtime'/>
    <on_poweroff>destroy</on_poweroff>
    <on_reboot>restart</on_reboot>
    <on_crash>restart</on_crash>

    <devices>
        <!-- Диск Windows -->
        <disk type='file' device='disk'>
            <driver name='qemu' type='qcow2' cache='writeback'/>
            <source file='/var/lib/libvirt/images/win11-gpu.qcow2'/>
            <target dev='vda' bus='virtio'/>
        </disk>

        <!-- VirtIO ISO -->
        <disk type='file' device='cdrom'>
            <driver name='qemu' type='raw'/>
            <source file='/usr/share/virtio-win/virtio-win.iso'/>
            <target dev='sdb' bus='sata'/>
            <readonly/>
        </disk>

        <!-- PCI passthrough GPU -->
        <hostdev mode='subsystem' type='pci' managed='yes'>
            <source>
                <address domain='0x0000' bus='0x01' slot='0x00' function='0'/>
            </source>
            <driver name='vfio'/>
        </hostdev>

        <!-- PCI passthrough HDMI-аудио того же GPU -->
        <hostdev mode='subsystem' type='pci' managed='yes'>
            <source>
                <address domain='0x0000' bus='0x01' slot='0x00' function='1'/>
            </source>
            <driver name='vfio'/>
        </hostdev>

        <!-- VirtIO сеть -->
        <interface type='network'>
            <source network='default'/>
            <model type='virtio'/>
        </interface>

        <!-- VirtIO диск для shared папки -->
        <filesystem type='mount' accessmode='passthrough'>
            <driver type='virtiofs'/>
            <source dir='/home/mikan/share'/>
            <target dir='shared'/>
        </filesystem>

        <!-- USB контроллер -->
        <controller type='usb' model='qemu-xhci'/>

        <!-- Устройства ввода -->
        <input type='tablet' bus='usb'/>
        <input type='keyboard' bus='usb'/>

        <!-- Эмуляция аудио (не обязательна, если GPU audio passthrough) -->
        <sound model='ich9'/>

        <!-- Дисплей QXL на случай отладки (можно убрать) -->
        <video>
            <model type='qxl' ram='65536' vram='65536' vgamem='16384'/>
        </video>
    </devices>
</domain>

| Компонент                         | Назначение                                                 |
| --------------------------------- | ---------------------------------------------------------- |
| `<hostdev ...>`                   | подключение GPU напрямую гостю                             |
    | `<driver name='vfio'/>`           | принудительно использовать VFIO вместо QEMU эмуляции       |
    | `<kvm><hidden state='on'/></kvm>` | маскирует гипервизор — нужно для NVIDIA (иначе “Error 43”) |
    | `<filesystem driver='virtiofs'/>` | монтирует общую папку `/home/mikan/share`                  |
    | `<cpu mode='host-passthrough'/>`  | максимально полное использование CPU                       |
    | `<sound model='ich9'/>`           | резервное аудио (если HDMI не используется)                |


    На госте (Windows)

    После установки:

    Ставишь драйверы GPU (официальные NVIDIA/AMD).

    Из virtio ISO — ставишь:

    VirtIO Ethernet

    VirtIO Balloon

    VirtIO RNG

    VirtIOFS драйвер

    (по желанию) — spice-guest-tools можно не ставить, если видеовывод идёт через GPU и монитор подключен напрямую к карте.


